/**
 * D3Bubbles
 *
 * Generate Bubbles chart
 * Helps you bring data to life using HTML, SVG and CSS.
 *
 * @param {Object} settings [description]
 *
 * @author      Kevin WENGER <contact@kevin-wenger.ch>
 * @license     http://www.php.net/license/3_01.txt  PHP License 3.01
 * @version     1.0.5
 *
 */
if("undefined"==typeof jQuery)throw new Error("D3Bubbles's JavaScript requires jQuery");if("undefined"==typeof d3)throw new Error("D3Bubbles's JavaScript requires D3.js");D3Bubbles=function(t){function e(){"auto"!=u.width&&u.features_responsive&&(console.warn('D3Bubbles\'s Warning - "responsive" enable but width != "auto".'),u.width="auto"),"auto"==u.width&&(u.width=$(h.container).width()),"auto"==u.height&&(u.height=$(h.container).height()),"auto"==u.bubbles_max&&(u.bubbles_max=parseInt(u.bubbles_per_px*u.width)),u.bubbles_max=u.bubbles_max>=h.data.length||u.bubbles_max<=0?h.data.length:parseInt(u.bubbles_max),f=d3.scale.ordinal().domain(d3.range(m)).rangePoints([0,u.width],1),$(h.container).html(""),b=d3.select(h.container).append("svg:svg").attr("width",u.width).attr("height",u.height).attr("class","D3Bubbles")}function r(t){var e=this,r=document.querySelector(h.wrapper),n=new CustomEvent("drag",{bubble:e,data:t});!r.dispatchEvent(n),t.py>u.height&&(t.py=u.height),t.py<0&&(t.py=0),t.px>u.width&&(t.px=u.width),t.px<0&&(t.px=0)}function n(t){c.each(a(.5*t.alpha)).each(s(.5)).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("transform",function(t){return"translate("+t.x+","+t.y+")"})}function a(t){return function(e){var r=e.radius+4;e.y+=(e.cy-e.y)*t,e.x+=(e.cx-e.x)*t/8,u.features_overflow||(e.x-r<0?e.x=r:e.x+r>u.width&&(e.x=u.width-r),e.y-r<0?e.y=r:e.y+r>u.height&&(e.y=u.height-r))}}function s(t){var e=d3.geom.quadtree(l);return function(r){var n=r.radius+d.domain()[1]+_,a=r.x-n,s=r.x+n,i=r.y-n,u=r.y+n;e.visit(function(e,n,o,l,b){if(e.point&&e.point!==r){var c=r.x-e.point.x,d=r.y-e.point.y,h=Math.sqrt(c*c+d*d),m=r.radius+e.point.radius;m>h&&(h=(h-m)/h*t,r.x-=c*=h,r.y-=d*=h,e.point.x+=c,e.point.y+=d)}return n>s||a>l||o>u||i>b})}}var i=t,u=this,o={width:"auto",height:"auto",wrapper:null,container:null,data:null,bubbles:{bubbles_per_px:.02,bubbles_max:"auto"},radius:{min:28,max:65},colors:{bubbles:["#c9ad7d","#e0c18c"],texts:["#FFF"]},features:{dragmove:!0,overflow:!1,fit_texts:!0,responsive:!0}},l=null,b=null,c=null,d=null,h=null,m=1,_=100,x=d3.layout.force(),f=null;this.width=null,this.height=null,this.bubbles_per_px=null,this.bubbles_max=null,this.radius_min=null,this.radius_max=null,this.colors_bubbles=null,this.colors_min_bubbles=null,this.colors_max_bubbles=null,this.colors_texts=null,this.colors_min_texts=null,this.colors_max_texts=null,this.features_dragmove=null,this.features_overflow=null,this.features_fit_texts=null,this.visualize=function(){var t=0;l=h.data,l=h.data.slice(0,u.bubbles_max);var e=d3.min(l,function(t){return parseInt(t.radius)}),a=d3.max(l,function(t){return parseInt(t.radius)});d=d3.scale.linear().domain([e,a]).range([u.radius_min,u.radius_max]);var s=function(){return u.colors_min_bubbles};null!=u.colors_max_bubbles&&(s=d3.scale.linear().domain([u.radius_min,u.radius_max]).range([u.colors_min_bubbles,u.colors_max_bubbles]));var i=function(){return u.colors_min_texts};if(null!=u.colors_max_texts&&(i=d3.scale.linear().domain([u.radius_min,u.radius_max]).range([u.colors_min_texts,u.colors_max_texts])),l.forEach(function(t){{var e=Math.floor(Math.random()*m);(e+1)/m*-Math.log(Math.random())}t.cx=f(e),t.cy=u.height/2,t.count=t.radius,t.radius=d(t.radius),t.name=t.name,t.id=Math.random().toString(36).substr(2,9)}),u.features_dragmove)var o=x.drag().on("dragstart",function(t){var e=this,r=document.querySelector(h.wrapper),n=new CustomEvent("dragstart",{bubble:e,data:t});!r.dispatchEvent(n)}).on("drag",r).on("dragend",function(t){var e=this,r=document.querySelector(h.wrapper),n=new CustomEvent("dragend",{bubble:e,data:t});!r.dispatchEvent(n)});x.size([u.width,u.height]).gravity(0).charge(0).nodes(l).on("tick",n).start(),c=b.selectAll("g").data(l).enter().append("g").attr("data-label-text",function(t){return t.name}).attr("data-label-count",function(t){return t.label}).attr("id",function(t){return"bubble-wrapper-"+t.id}).attr("class","bubble-wrapper").attr("cx",function(t){return t.cx}).attr("cy",function(t){return t.cy}).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),u.features_dragmove&&c.call(o);c.append("circle").attr("class",function(t){return"bubble "+t.type}).attr("fill",function(t){return s(t.radius)}).attr("r",function(t){return t.radius}),c.append("text").attr("class","term").attr("dy",".3em").attr("fill",function(t){return i(t.radius)}).style("text-anchor","middle").text(function(e){var r=this,n=document.querySelector(h.wrapper);if(t++,r.addEventListener("mouseleave",function(){var t=new CustomEvent("leave",{bubble:r,data:e});!n.dispatchEvent(t)}),r.addEventListener("mouseenter",function(){var t=new CustomEvent("enter",{bubble:r,data:e});!n.dispatchEvent(t)}),t>=u.bubbles_max){var a=new CustomEvent("complete");!n.dispatchEvent(a)}return e.name.substring(0,e.radius/3)}).style("font-size","10px").style("font-size",function(t){var e=10;return u.features_fit_texts&&(e=(2*t.radius-10)/this.getComputedTextLength()*10),e+"px"})},this.init=function(){h=$.extend(o,i),this.width=h.width,this.height=h.height,this.bubbles_per_px=h.bubbles.bubbles_per_px,this.bubbles_max=h.bubbles.bubbles_max,this.radius_min=h.radius.min,this.radius_max=h.radius.max,1==h.colors.bubbles.length?this.colors_min_bubbles=h.colors.bubbles[0]:h.colors.bubbles.length>1&&(this.colors_min_bubbles=h.colors.bubbles[0],this.colors_max_bubbles=h.colors.bubbles[1]),1==h.colors.texts.length?this.colors_min_texts=h.colors.texts[0]:h.colors.texts.length>1&&(this.colors_min_texts=h.colors.texts[0],this.colors_max_texts=h.colors.texts[1]),this.features_dragmove=h.features.dragmove,this.features_overflow=h.features.overflow,this.features_fit_texts=h.features.fit_texts,this.features_responsive=h.features.responsive,e()},this.redraw=function(){e(),this.visualize()}},function(){function t(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var r=document.createEvent("CustomEvent");return r.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),r}"function"==typeof t&&(t.prototype=window.Event.prototype,window.CustomEvent=t)}();
